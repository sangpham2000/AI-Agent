services:
  # =============================================================================
  # DATABASE SERVICES
  # =============================================================================
  
  postgres:
    image: pgvector/pgvector:pg16
    container_name: ai-agent-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres123}
      POSTGRES_DB: ${POSTGRES_DB:-ai_agent_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init-db:/docker-entrypoint-initdb.d
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-ai_agent_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai-agent-network

  # =============================================================================
  # AI ORCHESTRATION
  # =============================================================================
  
  flowise:
    image: flowiseai/flowise:3.0.12
    container_name: ai-agent-flowise
    restart: unless-stopped
    environment:
      - PORT=3000
      - FLOWISE_USERNAME=${FLOWISE_USERNAME:-admin}
      - FLOWISE_PASSWORD=${FLOWISE_PASSWORD:-admin123}
      - DATABASE_TYPE=postgres
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_USER=${POSTGRES_USER:-postgres}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-postgres123}
      - DATABASE_NAME=${FLOWISE_DB:-flowise_db}
      - APIKEY_PATH=/root/.flowise
      - SECRETKEY_PATH=/root/.flowise
      - LOG_LEVEL=info
      # OpenAI Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # Telegram Bot (được xử lý qua CoreService)
    volumes:
      - flowise_data:/root/.flowise
    ports:
      - "${FLOWISE_PORT:-3000}:3000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - ai-agent-network

  # =============================================================================
  # BACKEND SERVICES
  # =============================================================================
  
  agent-service:
    build:
      context: ./AgentService
      dockerfile: Dockerfile
    container_name: ai-agent-service
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=${POSTGRES_DB:-ai_agent_db};Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-postgres123}
      # Flowise Integration
      - Flowise__BaseUrl=http://flowise:3000
      - Flowise__ApiKey=${FLOWISE_API_KEY:-}
      # Telegram Bot Configuration
      - Telegram__BotToken=${TELEGRAM_BOT_TOKEN:-}
      - Telegram__WebhookUrl=${TELEGRAM_WEBHOOK_URL:-}
      # JWT Configuration
      - Jwt__Secret=${JWT_SECRET:-your-super-secret-jwt-key-here-min-32-chars}
      - Jwt__Issuer=${JWT_ISSUER:-ai-agent-api}
      - Jwt__Audience=${JWT_AUDIENCE:-ai-agent-clients}
    ports:
      - "${CORE_SERVICE_PORT:-5001}:8080"
    depends_on:
      postgres:
        condition: service_healthy
      flowise:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - ai-agent-network

  # =============================================================================
  # FRONTEND SERVICES
  # =============================================================================
  
  dashboard:
    build:
      context: ./Agent-dashboard
      dockerfile: Dockerfile
    container_name: ai-agent-dashboard
    restart: unless-stopped
    ports:
      - "${DASHBOARD_PORT:-8080}:80"
    depends_on:
      - agent-service
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ai-agent-network

  plugin:
    build:
      context: ./Agent-plugin
      dockerfile: Dockerfile
    container_name: ai-agent-plugin
    restart: unless-stopped
    ports:
      - "${PLUGIN_PORT:-8081}:80"
    depends_on:
      - agent-service
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ai-agent-network

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  ai-agent-network:
    driver: bridge
    name: ai-agent-network

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  postgres_data:
    name: ai-agent-postgres-data
  flowise_data:
    name: ai-agent-flowise-data
